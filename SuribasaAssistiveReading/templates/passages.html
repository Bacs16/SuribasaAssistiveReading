{% extends 'base.html' %} 
{% block content %}

<section class="grid">
  <!-- Create -->
  <div class="card">
    <h2>Create Passage</h2>
    <form id="createPassageForm" method="post" enctype="multipart/form-data" class="form">
      <label>Title <input name="title" required></label>

      <!-- Segmented grade selector -->
      <label class="block">Grade Level
  <select name="grade_level" class="input" style="margin-top:.35rem">
    <option value="" selected disabled>Choose grade…</option>
    <option value="7">Grade 7</option>
    <option value="8">Grade 8</option>
    <option value="9">Grade 9</option>
    <option value="10">Grade 10</option>
  </select>
</label>

      <label>Paste Text
        <textarea id="passageText" name="text" rows="6" placeholder="Paste passage here..."></textarea>
      </label>

      <div class="row" style="gap:10px;align-items:center">
        <label>Or Upload .txt <input id="fileTxt" type="file" name="file" accept=".txt"></label>
        <button class="button" type="submit">Save</button>
      </div>
      <div class="muted" style="margin-top:.35rem">Tip: Provide either pasted text or a .txt file.</div>
    </form>
  </div>

  <!-- Existing (upgraded) -->
  <div class="card">
    <div class="table-header">
      <div>
        <h2 style="margin:0">Existing Passages</h2>
        <div class="muted" id="passageCount">{{ passages|length }} total</div>
      </div>

      <div class="table-tools">
        <input id="tableSearch" class="input" type="search" placeholder="Search title or grade…"/>
        <label class="muted" style="display:flex;gap:.5rem;align-items:center">
          Rows/page
          <select id="rowsPerPage" class="input small">
            <option>5</option><option selected>10</option><option>25</option><option>50</option><option value="0">All</option>
          </select>
        </label>
      </div>
    </div>

    <div class="table-wrap">
      <table class="data-table" id="passagesTable">
        <thead>
          <tr>
            <th data-sort="string">Title</th>
            <th data-sort="number" style="width:110px">Grade Level</th>
            <th data-sort="date" style="width:160px">Created</th>
            <th class="actions" style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in passages %}
          <tr data-id="{{ p.id }}"
              data-title="{{ p.title|e }}"
              data-grade="{{ p.grade_level }}"
              data-date="{{ p.created_at.isoformat() }}">
            <td data-label="Title">
              <a href="{{ url_for('passage_view', pid=p.id) }}" class="link strong">{{ p.title }}</a>
              <template class="passage-text">{{ p.text|e }}</template>
            </td>
            <td data-label="Grade">{{ p.grade_level }}</td>
            <td data-label="Created">
              <time datetime="{{ p.created_at.isoformat() }}">{{ p.created_at.strftime('%Y-%m-%d') }}</time>
            </td>
            <td class="actions">
              <!-- Preview -->
              <button class="iconbtn ghost open-modal" title="Preview" data-id="{{ p.id }}" aria-label="Preview">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M12 5c-5 0-9 5-9 7s4 7 9 7 9-5 9-7-4-7-9-7zm0 12c-2.8 0-5-2.24-5-5s2.2-5 5-5 5 2.24 5 5-2.2 5-5 5zm0-8a3 3 0 100 6 3 3 0 000-6z"/></svg>
              </button>
              <!-- Edit -->
              <a class="iconbtn" href="{{ url_for('passage_edit', pid=p.id) }}" title="Edit" aria-label="Edit">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
              </a>
              <!-- Delete -->
              <form method="POST" action="{{ url_for('passage_delete', pid=p.id) }}" class="inline"
                    onsubmit="return confirm('Delete this passage?');">
                <button class="iconbtn danger" type="submit" title="Delete" aria-label="Delete">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z"/></svg>
                </button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="muted">No passages yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination footer -->
    <div class="pager">
      <div id="rangeInfo" class="muted">—</div>
      <div class="pager-controls">
        <button class="iconbtn ghost" id="firstPage" title="First" aria-label="First">
          <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M6 12l8-8v6h8v4h-8v6z"/></svg>
        </button>
        <button class="iconbtn ghost" id="prevPage" title="Previous" aria-label="Previous">
          <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </button>
        <span id="pageInfo" class="muted">1 / 1</span>
        <button class="iconbtn ghost" id="nextPage" title="Next" aria-label="Next">
          <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
        </button>
        <button class="iconbtn ghost" id="lastPage" title="Last" aria-label="Last">
          <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M18 12l-8 8v-6H2v-4h8V4z"/></svg>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Modal -->
<div id="passageModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-backdrop" data-close></div>
  <div class="modal-card" role="document">
    <header class="modal-head">
      <h3 id="modalTitle" class="modal-title">Passage</h3>
      <button class="iconbtn ghost" data-close aria-label="Close">
        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.3 9.17 12 2.88 5.71 4.29 4.29l6.3 6.3 6.29-6.3z"/></svg>
      </button>
    </header>
    <section class="modal-body">
      <div class="muted" id="modalMeta"></div>
      <pre id="modalText" class="modal-text"></pre>
    </section>
    <footer class="modal-foot">
      <a id="modalView" class="button ghost">Open</a>
      <a id="modalEdit" class="button">Edit</a>
      <form id="modalDeleteForm" method="POST" class="inline" onsubmit="return confirm('Delete this passage?');">
        <button class="button danger">Delete</button>
      </form>
    </footer>
  </div>
</div>

<style>
/* Inputs */
.table-tools .input{padding:.55rem .75rem;border-radius:.6rem;border:1px solid var(--border,#253142);background:rgba(255,255,255,.03);color:inherit}
.input.small{padding:.4rem .55rem}

/* Segmented control for Grade Level */
.segmented{display:inline-flex;gap:.35rem;margin-top:.35rem}
.seg-btn{position:relative;display:inline-flex;align-items:center;justify-content:center}
.seg-btn input{position:absolute;inset:0;opacity:0}
.seg-btn span{display:inline-block;padding:.4rem .65rem;border:1px solid var(--border,#253142);border-radius:.6rem;background:rgba(255,255,255,.04);user-select:none}
.seg-btn input:checked + span{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.45)}

/* Table */
.table-wrap{overflow:auto;border:1px solid var(--border,#253142);border-radius:12px}
.data-table{width:100%;border-collapse:separate;border-spacing:0}
.data-table thead th{position:sticky;top:0;background:rgba(255,255,255,.04);border-bottom:1px solid var(--border,#253142);text-align:left;font-weight:700;padding:.85rem 1rem;user-select:none;cursor:pointer}
.data-table thead th.actions{cursor:default}
.data-table thead th.sort-asc::after{content:" ▲";opacity:.8}
.data-table thead th.sort-desc::after{content:" ▼";opacity:.8}
.data-table tbody td{padding:.85rem 1rem;border-bottom:1px solid rgba(255,255,255,.06)}
.data-table tbody tr:hover{background:rgba(255,255,255,.04)}
.link.strong{font-weight:600}

/* Icon buttons */
.iconbtn{display:inline-flex;align-items:center;justify-content:center;gap:.35rem;padding:.35rem .5rem;border-radius:.5rem;border:1px solid transparent;background:rgba(255,255,255,.06);color:inherit}
.iconbtn:hover{background:rgba(255,255,255,.1)}
.iconbtn.ghost{background:transparent;border-color:transparent}
.iconbtn.danger{background:rgba(220,38,38,.12);color:#fecaca;border-color:rgba(220,38,38,.24)}
.iconbtn.danger:hover{background:rgba(220,38,38,.2)}
.button.ghost{background:transparent;border:1px solid var(--border,#253142)}

/* Pager */
.pager{display:flex;justify-content:space-between;align-items:center;margin-top:.75rem}
.pager-controls{display:flex;gap:.35rem;align-items:center}
#pageInfo{min-width:64px;text-align:center}

/* Modal */
.modal{position:fixed;inset:0;display:none}
.modal.show{display:block}
.modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
.modal-card{position:relative;max-width:820px;margin:6vh auto;background:var(--card,#0b1320);border:1px solid var(--border,#253142);border-radius:16px;box-shadow:0 20px 70px rgba(0,0,0,.45);display:flex;flex-direction:column}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid var(--border,#253142)}
.modal-title{margin:0}
.modal-body{padding:1rem 1.25rem;max-height:55vh;overflow:auto}
.modal-text{white-space:pre-wrap;line-height:1.5;font-family:ui-sans-serif,system-ui,Segoe UI,Inter,Arial}
.modal-foot{display:flex;gap:.5rem;justify-content:flex-end;padding:1rem 1.25rem;border-top:1px solid var(--border,#253142)}
.inline{display:inline}
@media (max-width:720px){
  .data-table thead th:nth-child(3), .data-table tbody td:nth-child(3){display:none}
  .modal-card{margin:3vh .75rem}
}
</style>

<script>
(function(){
  // Validate "Create Passage": must have pasted text OR a file
  const form = document.getElementById('createPassageForm');
  const textEl = document.getElementById('passageText');
  const fileEl = document.getElementById('fileTxt');

  form.addEventListener('submit', (e) => {
    const hasText = (textEl.value || '').trim().length > 0;
    const hasFile = !!(fileEl.files && fileEl.files.length);
    if (!hasText && !hasFile) {
      e.preventDefault();
      alert('Please paste text or upload a .txt file.');
      return false;
    }
  });

  // ------------- existing table JS -------------
  const table = document.getElementById('passagesTable');
  const tbody = table.querySelector('tbody');
  const headers = table.querySelectorAll('thead th[data-sort]');
  const search = document.getElementById('tableSearch');
  const countEl = document.getElementById('passageCount');
  const rowsPerPageSel = document.getElementById('rowsPerPage');
  const pageInfo = document.getElementById('pageInfo');
  const rangeInfo = document.getElementById('rangeInfo');

  // Modal refs
  const modal = document.getElementById('passageModal');
  const modalText = document.getElementById('modalText');
  const modalMeta = document.getElementById('modalMeta');
  const modalTitle = document.getElementById('modalTitle');
  const modalView = document.getElementById('modalView');
  const modalEdit = document.getElementById('modalEdit');
  const modalDeleteForm = document.getElementById('modalDeleteForm');

  // Pager buttons
  const btnFirst = document.getElementById('firstPage');
  const btnPrev = document.getElementById('prevPage');
  const btnNext = document.getElementById('nextPage');
  const btnLast = document.getElementById('lastPage');

  // State
  let sortState = { index: 2, dir: 'desc' }; // default: Created desc
  let page = 1;
  let pageSize = parseInt(rowsPerPageSel.value, 10);

  function allRows(){ return Array.from(tbody.querySelectorAll('tr')); }

  function parseVal(td, type){
    const txt = (td.textContent || '').trim();
    if(type === 'number') return parseFloat(txt.replace(/[^0-9.-]/g,'')) || 0;
    if(type === 'date')   return new Date(td.querySelector('time')?.getAttribute('datetime') || txt).getTime() || 0;
    return txt.toLowerCase();
  }

  function sortRows(){
    const rows = allRows();
    const th = headers[sortState.index];
    rows.sort((a,b)=>{
      const va = parseVal(a.children[sortState.index], th.dataset.sort);
      const vb = parseVal(b.children[sortState.index], th.dataset.sort);
      if(va < vb) return sortState.dir === 'asc' ? -1 : 1;
      if(va > vb) return sortState.dir === 'asc' ? 1 : -1;
      return 0;
    });
    rows.forEach(r=>tbody.appendChild(r));
  }

  function filterRows(){
    const q = (search.value || '').toLowerCase();
    let visible = 0;
    allRows().forEach(tr=>{
      const text = tr.innerText.toLowerCase();
      const show = text.includes(q);
      tr.dataset._visible = show ? '1' : '0';
      if(show) visible++;
    });
    countEl.textContent = `${visible} total`;
    return visible;
  }

  function paginate(){
    const visibleRows = allRows().filter(r=>r.dataset._visible !== '0');
    const total = visibleRows.length;
    const ps = pageSize === 0 ? total : pageSize; // 0 = All
    const totalPages = Math.max(1, Math.ceil(total / ps));
    page = Math.min(page, totalPages);

    visibleRows.forEach(r=>r.style.display='none');
    if(total){
      const start = (page-1)*ps;
      const end = pageSize === 0 ? total : Math.min(start+ps, total);
      visibleRows.slice(start, end).forEach(r=>r.style.display='');
      rangeInfo.textContent = `${start+1}–${end} of ${total}`;
      pageInfo.textContent = `${page} / ${totalPages}`;
    }else{
      rangeInfo.textContent = `0 of 0`;
      pageInfo.textContent = `1 / 1`;
    }
  }

  // Event: sort click
  headers.forEach((th, i)=>{
    th.addEventListener('click', ()=>{
      if(!th.dataset.sort) return;
      if(sortState.index === i){ sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc'; }
      else { sortState.index = i; sortState.dir = 'asc'; }
      headers.forEach(h=>h.classList.remove('sort-asc','sort-desc'));
      th.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
      sortRows(); filterRows(); paginate();
    });
  });

  // Event: search
  search.addEventListener('input', ()=>{ page=1; filterRows(); paginate(); });

  // Event: rows per page
  rowsPerPageSel.addEventListener('change', ()=>{
    pageSize = parseInt(rowsPerPageSel.value, 10);
    page = 1; paginate();
  });

  // Pager buttons
  btnFirst.addEventListener('click', ()=>{ page=1; paginate(); });
  btnPrev .addEventListener('click', ()=>{ page=Math.max(1,page-1); paginate(); });
  btnNext .addEventListener('click', ()=>{ page=page+1; paginate(); });
  btnLast.addEventListener('click', ()=>{
    const vis = allRows().filter(r=>r.dataset._visible !== '0').length;
    const ps = pageSize===0?vis:pageSize;
    page = Math.max(1, Math.ceil(vis/ps));
    paginate();
  });

  // Modal helpers
  function openModalForRow(tr){
    const id = tr.dataset.id;
    const title = tr.dataset.title;
    const grade = tr.dataset.grade;
    const iso = tr.dataset.date;
    const created = new Date(iso).toLocaleDateString();
    const textTpl = tr.querySelector('template.passage-text');
    const text = (textTpl ? textTpl.textContent : '').trim();

    modalTitle.textContent = title;
    modalMeta.textContent = `Grade ${grade} • ${created}`;
    modalText.textContent = text;

    modalView.href = "{{ url_for('passage_view', pid=0) }}".replace("0", id);
    modalEdit.href = "{{ url_for('passage_edit', pid=0) }}".replace("0", id);
    modalDeleteForm.action = "{{ url_for('passage_delete', pid=0) }}".replace("0", id);

    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    modal.querySelector('[data-close]').focus();
    lastFocus = document.activeElement;
  }

  let lastFocus = null;
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.open-modal');
    if(btn){
      e.preventDefault();
      const id = btn.getAttribute('data-id');
      const tr = tbody.querySelector(`tr[data-id="${id}"]`);
      if(tr) openModalForRow(tr);
    }
    if(e.target.matches('[data-close]') || e.target.closest('[data-close]')) closeModal();
  });

  function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    if(lastFocus) lastFocus.focus();
  }
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });

  // Init
  headers[sortState.index].classList.add('sort-desc');
  sortRows(); filterRows(); paginate();
})();
</script>
{% endblock %}
